#!/usr/bin/env node
//æ ¸å¿ƒå¤„ç†å‘½ä»¤è¡Œ
const program = require("commander");
//ç»ˆç«¯é¢œè‰²æ‰“å°
const chalk = require("chalk");
//æ¸å˜è‰²çš„ç‰ˆæœ¬å·
const Printer = require("@darkobits/lolcatjs");
//loadingçŠ¶æ€
const ora = require("ora");
//å’Œç”¨æˆ·äº¤äº’
//prompts
const inquirer = require("inquirer");
//ç»™ç”¨æˆ·çš„ç³»ç»Ÿè¿›è¡Œäº¤äº’
const shelljs = require("shelljs");
//è·å–ç”¨æˆ·çš„æ ¹èŠ‚ç‚¹ ç„¶åé»˜è®¤æˆ‘ä»¬åˆ›å»ºåœ¨ç”¨æˆ·çš„æ¡Œé¢
const userHome = require("user-home");
console.log(userHome)
//å¼•å…¥é¡¹ç›®æ ¹åº“
const download = require("download-git-repo");
//è¿™é‡Œæ˜¯æˆ‘ä»¬è¾›è¾›è‹¦è‹¦å†™å¥½çš„æ„å»ºé¡¹ç›®
const template = "direct:https://github.com/Shiyanping/react-node-ts-template.git";
//å½“å‰cliçš„ç‰ˆæœ¬å·
const _version = require("../package").version;
const input = [
  "   ---------------+--------------- ",
  "          ___ /^^[___              _",
  "         /|^+----+   |#___________/ /",
  "       ( -+ |____|   _______-----+/",
  "        ==_________--'             ",
  "          ~_|___|__ -â™š sypâ™š " + _version + "",
  "         "
].join("\n");
//å‘½ä»¤è¡Œå¤„ç†å‡½æ•°
const binHandler = {
  init() {
    console.log("è¿›å…¥åˆå§‹åŒ–èŠ‚ç‚¹...");
    inquirer
      .prompt([
        {
          type: "text",
          message: "1ï¸âƒ£ è¯·è¾“å…¥æ–‡ä»¶å¤¹åç§°",
          name: "dirname"
        },
        {
          type: "list",
          message: "2ï¸âƒ£ è¯·é€‰æ‹©ä½¿ç”¨è¯­è¨€",
          choices: ["âœ” TypeScript", "âœ” EcmaScript6"],
          name: "jskind"
        }
      ])
      .then(answers => {
        // console.log("xxxx", answers.dirname);
        // console.log("xxxx", answers.jskind);
        const _dirname = answers.dirname;
        if (_dirname) {
          const spinner = ora("ğŸ‘©â€ğŸ’»downloading template...");
          spinner.start();
          //é¡¹ç›®çš„å…¨è·¯å¾„ æ¯æ¬¡æ¸…é™¤
          const _projectPath = `${userHome}/Desktop/${_dirname}`;
          shelljs.cd(`${userHome}/Desktop/`);
          shelljs.rm("-rf", _projectPath);
          shelljs.mkdir(_dirname);
          download(template, _projectPath, { clone: true }, err => {
            spinner.stop();
            if (err) {
              console.error(
                "Failed to download repo " +
                  template +
                  ": " +
                  err.message.trim()
              );
            } else {
              //ç”¨linux shell sedæŠŠpackage.jsonçš„åŒ…åæ¢æ‰
              shelljs.sed(
                "-i",
                "yd-vue-kernel",
                _dirname,
                _projectPath + "/package.json"
              );
              console.log(chalk.green("ğŸ‘©â€ğŸš’é¡¹ç›®åˆ›å»ºæˆåŠŸenjoy development~"));
            }
          });
        }
      })
      .catch(function(error) {
        console.log(chalk.red("ğŸ¤·â€ yd-cliå¯åŠ¨å¼‚å¸¸", error));
      });
    // setTimeout(function(){
    //     spinner.stop();
    // },2000);
  },
  build() {
    console.log("å¯åŠ¨ç¼–è¯‘");
  },
  test() {
    console.log("å¯åŠ¨æµ‹è¯•");
  }
};
//è®¾ç½®ç”¨æˆ·çš„ç‰ˆæœ¬ç¼–å·ã€ç‰¹æ®Šå¤„ç†ã€‘
program.version(Printer.default.fromString(input), "-v, --version");
program.option("-i, --init", "è®¾ç½®ç›¸åº”ğŸˆ");
program
  .usage("[cmd] <options>")
  //init å’Œintä¸ä¸€æ ·å“¦ åé¢ä¸å¸¦ç©ºæ ¼çš„è¯éœ€è¦æŒ‡å®šyd-test æ‹†åˆ†ç»„ä»¶é€»è¾‘
  .arguments("<cmd> [env]")
  .action(function(cmd, otherParams) {
    const handler = binHandler[cmd];
    // console.log(cmd);
    if (typeof handler === "undefined") {
      console.error(
        chalk.yellow("ğŸ™ éå¸¸é—æ†¾") +
          "ã€" +
          chalk.red(cmd) +
          " ã€‘" +
          chalk.yellow("æš‚æœªæä¾›~")
      );
      process.exit(1);
    } else {
      handler(otherParams);
    }
  });
//ç³»ç»Ÿè‡ªå¸¦çš„Commands
//   program
//     //init å’Œintä¸ä¸€æ ·å“¦ åé¢ä¸å¸¦ç©ºæ ¼çš„è¯éœ€è¦æŒ‡å®šyd-test æ‹†åˆ†ç»„ä»¶é€»è¾‘
//     .command("init ", "åˆå§‹åŒ–é¡¹ç›®")
//     .command("test ", "æ‰§è¡Œé¡¹ç›®æµ‹è¯•")
//     .command("build ", "æ„å»ºé¡¹ç›®ğŸŒ°");
const start = "  ";
program.on("--help", function() {
  console.log("");
  console.log("Commands:");
  console.log(chalk.green(`${start}init -i       ğŸ‘¨â€ğŸ³ åˆå§‹åŒ–é¡¹ç›®`));
  console.log(chalk.yellow(`${start}build -b      ğŸ“¦ ç¼–è¯‘é¡¹ç›®`));
  console.log(chalk.blue(`${start}test -t       ğŸš§ æµ‹è¯•é¡¹ç›®`));
  console.log("");
});
program.parse(process.argv);
if (program.init) console.log(program.init);
